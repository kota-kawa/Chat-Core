name: CI Quality

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-quality-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Ruff Lint (Light)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run light lint checks
        run: python -m ruff check app.py blueprints services tests --select E9,F63,F7,F82

  endpoint_tests:
    name: Endpoint Tests (API Routes)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run endpoint route tests
        run: python -m unittest tests.test_endpoint_routes -v

  unittest:
    name: Python ${{ matrix.python-version }} / unittest
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit tests
        run: python -m unittest discover -s tests -p "test_*.py" -v

  coverage:
    name: Coverage Report (No Threshold)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install coverage

      - name: Run tests with coverage
        run: coverage run -m unittest discover -s tests -p "test_*.py"

      - name: Show coverage report
        run: coverage report -m --omit="tests/*"

      - name: Export coverage XML
        run: coverage xml -o coverage.xml --omit="tests/*"

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

  deploy:
    name: Deploy (main push)
    runs-on: ubuntu-latest
    needs: [lint, endpoint_tests, unittest, coverage]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 15

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script_stop: true
          script: |
            set -euo pipefail

            cd /var/www/Chat-Core

            PREV_COMMIT="$(git rev-parse HEAD)"
            rollback() {
              echo "Deploy failed. Rolling back to ${PREV_COMMIT}"
              git reset --hard "${PREV_COMMIT}"
              docker compose up -d --build || true
            }
            trap rollback ERR

            git fetch origin main
            git reset --hard origin/main

            if [ ! -f .env ]; then
              cp .env.example .env
              echo "Created .env from .env.example. Please update it with actual secrets."
            fi

            docker compose up -d --build

            docker compose ps
            for service in app frontend db redis; do
              cid="$(docker compose ps -q "${service}")"
              if [ -z "${cid}" ]; then
                echo "Service ${service} container is missing."
                exit 1
              fi

              retries=30
              while [ "${retries}" -gt 0 ]; do
                status="$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}{{.State.Status}}{{end}}' "${cid}")"
                if [ "${status}" = "healthy" ] || [ "${status}" = "running" ]; then
                  echo "Service ${service} is ${status}"
                  break
                fi
                if [ "${status}" = "unhealthy" ] || [ "${status}" = "exited" ] || [ "${status}" = "dead" ]; then
                  echo "Service ${service} is ${status}"
                  exit 1
                fi
                sleep 2
                retries=$((retries - 1))
              done

              if [ "${retries}" -eq 0 ]; then
                echo "Timed out waiting for service ${service} to become ready."
                exit 1
              fi
            done

            docker image prune -f
            trap - ERR
