import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.resolve(__dirname, "..");

const bundles = [
  {
    entry: "public/static/css/pages/chat/index.css",
    out: "public/static/css/pages/chat/index.bundle.css"
  },
  {
    entry: "public/static/css/pages/user_settings/index.css",
    out: "public/static/css/pages/user_settings/index.bundle.css"
  },
  {
    entry: "public/prompt_share/static/css/pages/prompt_share.css",
    out: "public/prompt_share/static/css/pages/prompt_share.bundle.css"
  },
  {
    entry: "public/prompt_share/static/css/pages/prompt_manage.css",
    out: "public/prompt_share/static/css/pages/prompt_manage.bundle.css"
  }
];

const importPattern = /^\s*@import\s+url\((['"]?)([^'"\)]+)\1\)\s*;\s*$/gm;

function resolveImport(fromFile, specifier) {
  if (specifier.startsWith("/")) {
    return path.resolve(projectRoot, `.${specifier}`);
  }
  return path.resolve(path.dirname(fromFile), specifier);
}

function inlineCss(filePath, stack = []) {
  if (stack.includes(filePath)) {
    const cycle = [...stack, filePath].map((p) => path.relative(projectRoot, p)).join(" -> ");
    throw new Error(`Circular CSS import detected: ${cycle}`);
  }

  if (!fs.existsSync(filePath)) {
    throw new Error(`CSS file not found: ${path.relative(projectRoot, filePath)}`);
  }

  const stackNext = [...stack, filePath];
  const raw = fs.readFileSync(filePath, "utf8").replace(/\r\n/g, "\n");

  return raw.replace(importPattern, (_match, _quote, importPath) => {
    const resolved = resolveImport(filePath, importPath);
    const inlined = inlineCss(resolved, stackNext).trim();
    return `/* BEGIN inlined: ${path.relative(projectRoot, resolved)} */\n${inlined}\n/* END inlined: ${path.relative(projectRoot, resolved)} */`;
  });
}

function buildBundle(entryRel, outRel) {
  const entryAbs = path.resolve(projectRoot, entryRel);
  const outAbs = path.resolve(projectRoot, outRel);
  const content = inlineCss(entryAbs).trim();
  const banner = [
    "/* Auto-generated by scripts/build-css-bundles.mjs */",
    `/* Source: ${entryRel} */`
  ].join("\n");

  fs.mkdirSync(path.dirname(outAbs), { recursive: true });
  fs.writeFileSync(outAbs, `${banner}\n\n${content}\n`, "utf8");
  return { entryRel, outRel };
}

const built = bundles.map(({ entry, out }) => buildBundle(entry, out));
for (const item of built) {
  console.log(`Built ${item.outRel} (from ${item.entryRel})`);
}
