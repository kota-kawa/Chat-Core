<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ChatCore-AI</title>
  <link rel="icon" type="image/webp" href="{{ url_for('static', filename='favicon.webp') }}" />
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" />
  <!-- Google Fonts: Noto Sans JP -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=IBM+Plex+Sans:wght@400;700&display=swap"
    rel="stylesheet">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/chat/index.css') }}">


</head>

<body>

  <!-- 浮遊メニュー -->
  <action-menu></action-menu>

  <!-- 既存の settings-btn のすぐ下あたりに追加 -->
  <!-- 未ログイン時の認証ボタン -->
  <div id="auth-buttons" style="display:none; position:absolute; top:10px; right:10px;">
    <button id="login-btn" class="auth-btn">
      <i class="bi bi-person-circle"></i>
      <span>ログイン</span>
    </button>
  </div>


  <!-- ログイン後のユーザーアイコン -->
  <user-icon id="userIcon" style="display: none;"></user-icon>

  <div id="setup-container">
    <form class="setup-form" id="setup-form">
      <h2 style="text-align: center; margin-bottom: 1.5rem;">AI Assistant
        セットアップ</h2>
      <div class="form-group">
        <label class="form-label">現在の状況・作業環境（入力なしでもOK）</label>
        <textarea id="setup-info" rows="4" placeholder="例：大学生、リモートワーク中　／　自宅のデスク、周囲は静か"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">AIモデル選択</label>
        <select id="ai-model">
          <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite（高速・軽量）</option>
          <option value="gemini-2.5-flash" selected>gemini-2.5-flash（標準・推奨）</option>
        </select>
      </div>

      <!-- 画面中央モーダル -->
      <div id="io-modal" style="display: none;">
        <div class="io-modal-content" id="io-modal-content">
          <!-- JS で入出力例をここに挿入 -->
        </div>
      </div>

      <div class="task-selection-header">
        <p id="task-selection-text">実行したいタスクを選択（クリックで即実行）</p>
        <button id="openNewPromptModal" class="circle-button new-prompt-modal-btn" type="button" title="新しいプロンプトを投稿">
          <i class="bi bi-plus-lg"></i>
        </button>
        <!-- タスク編集ボタンは task_manager.js で後から追加され、CSSの order で中央に表示されます -->
      </div>

      <div class="task-selection" id="task-selection"></div>

      <!-- これまでのチャットを見るボタン -->
      <div style="text-align: center; margin-top: 0.2rem;">
        <button id="access-chat-btn" type="button" class="primary-button">
          <i class="bi bi-chat-left-text"></i> これまでのチャットを見る
        </button>
      </div>
    </form>
  </div>

  <div id="chat-container">
    <div class="chat-header">
      <div class="header-left">
        <button id="back-to-setup" class="icon-button" title="設定変更">
          <i class="bi bi-arrow-left"></i>
        </button>
        <span>AI Assistant Pro</span>
      </div>

      <div class="typing-indicator" id="typing-indicator" style="display: none;">
        <div class="typing-dot"></div>
        <div class="typing-dot" style="animation-delay: 0.2s"></div>
        <div class="typing-dot" style="animation-delay: 0.4s"></div>
      </div>
    </div>
    <div class="chat-main">
      <div class="sidebar" id="chat-room-sidebar">
        <button id="new-chat-btn" class="new-chat-btn">
          <i class="bi bi-plus-lg"></i> 新規チャット
        </button>
        <div id="chat-room-list"></div>
      </div>
      <div class="chat-area">

        <button id="sidebar-toggle" class="icon-button sidebar-toggle chat-sidebar-toggle" title="チャットルーム">
          <i class="bi bi-arrow-bar-right"></i>
        </button>

        <div class="chat-messages" id="chat-messages"></div>
        <div class="input-container">
          <div class="input-wrapper">
            <input type="text" id="user-input" placeholder="メッセージを入力..." />
            <button class="primary-button" id="send-btn">
              <i class="bi bi-send"></i>
            </button>
          </div>
        </div>
        <chat-action-menu></chat-action-menu>
      </div>
    </div>
  </div>

  <!-- 新規追加：新しいプロンプトモーダル -->
  <div id="newPromptModal" class="new-prompt-modal">
    <div class="new-prompt-modal-content">
      <!-- 閉じるボタン -->
      <span class="new-modal-close-btn" id="newModalCloseBtn">&times;</span>
      <h2>新しいプロンプトを投稿</h2>
      <form class="new-post-form" id="newPostForm">
        <div class="form-group">
          <label for="new-prompt-title">タイトル</label>
          <input type="text" id="new-prompt-title" placeholder="プロンプトのタイトルを入力" required />
        </div>
        <div class="form-group">
          <label for="new-prompt-content">プロンプト内容</label>
          <textarea id="new-prompt-content" rows="5" placeholder="具体的なプロンプト内容を入力" required></textarea>
        </div>
        <!-- ガードレールチェック -->
        <div class="form-group">
          <label>
            <input type="checkbox" id="new-guardrail-checkbox" />
            入出力例を追加する
          </label>
        </div>
        <!-- ガードレールがONのときだけ表示される部分 -->
        <div id="new-guardrail-fields">
          <div class="form-group">
            <label for="new-prompt-input-example">入力例（プロンプト内容とは別にしてください）</label>
            <textarea id="new-prompt-input-example" rows="3" placeholder="例: 夏休みの思い出をテーマにした短いエッセイを書いてください。"></textarea>
          </div>
          <div class="form-group">
            <label for="new-prompt-output-example">出力例</label>
            <textarea id="new-prompt-output-example" rows="3" placeholder="例: 夏休みのある日、私は家族と一緒に海辺へ出かけました..."></textarea>
          </div>
        </div>
        <button type="submit" class="submit-btn">
          <i class="bi bi-upload"></i> 投稿する
        </button>
      </form>
    </div>
  </div>

  <!-- Task Edit Modal -->
  <div id="taskEditModal" class="custom-modal" style="display: none;">
    <div class="custom-modal-dialog">
      <div class="custom-modal-content">
        <div class="custom-modal-header">
          <h5 class="custom-modal-title">タスク編集</h5>
          <button type="button" class="custom-modal-close" id="closeTaskEditModal">×</button>
        </div>
        <div class="custom-modal-body">
          <form id="taskEditForm">
            <!-- タスク名 -->
            <div class="custom-form-group">
              <label for="taskName" class="custom-form-label"><span style="color: green;">タイトル</span></label>
              <input type="text" class="custom-form-control" id="taskName" name="name" placeholder="例：メール作成">
              <div class="custom-form-text">タスクの名前を入力してください。</div>
            </div>
            <!-- プロンプトテンプレート -->
            <div class="custom-form-group">
              <label for="promptTemplate" class="custom-form-label"><span
                  style="color: green;">プロンプトテンプレート</span></label>
              <textarea class="custom-form-control" id="promptTemplate" name="prompt_template" rows="2"
                placeholder="例：メール本文の書き出し..."></textarea>
              <div class="custom-form-text">タスク実行時に使用するプロンプトテンプレートです。</div>
            </div>
            <!-- 入力例 -->
            <div class="custom-form-group">
              <label for="inputExamples" class="custom-form-label"><span style="color: green;">入力例</span></label>
              <textarea class="custom-form-control" id="inputExamples" name="input_examples" rows="2"
                placeholder="例：今日の天気は？"></textarea>
              <div class="custom-form-text">ユーザーが入力する例です。</div>
            </div>
            <!-- 出力例 -->
            <div class="custom-form-group">
              <label for="outputExamples" class="custom-form-label"><span style="color: green;">出力例</span></label>
              <textarea class="custom-form-control" id="outputExamples" name="output_examples" rows="2"
                placeholder="例：晴れです。"></textarea>
              <div class="custom-form-text">タスク実行時の出力例です。</div>
            </div>

          </form>
        </div>
        <div class="custom-modal-footer">
          <button type="button" class="custom-btn-secondary" id="cancelTaskEditModal">キャンセル</button>
          <button type="button" class="custom-btn-primary" id="saveTaskChanges">保存</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/dompurify@2.4.0/dist/purify.min.js" defer></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>



  <script src="{{ url_for('static', filename='js/core/dom.js') }}"></script>

  <!-- 共通ユーティリティ -->
  <script src="{{ url_for('static', filename='js/chat/message_utils.js') }}"></script>

  <!-- ★チャット機能(順序に注意) -->
  <script src="{{ url_for('static', filename='js/chat/chat_ui.js') }}"></script>
  <script src="{{ url_for('static', filename='js/chat/chat_messages.js') }}"></script>
  <script src="{{ url_for('static', filename='js/chat/chat_history.js') }}"></script>
  <script src="{{ url_for('static', filename='js/chat/chat_rooms.js') }}"></script>
  <script src="{{ url_for('static', filename='js/chat/chat_controller.js') }}"></script>
  <!-- セットアップ -->
  <script src="{{ url_for('static', filename='js/setup/setup.js') }}"></script>
  <!-- 画面ロード時の初期化 -->
  <script src="{{ url_for('static', filename='js/core/main.js') }}"></script>
  <!-- タスク関連＋プロンプトモーダル -->
  <script src="{{ url_for('static', filename='js/setup/task_manager.js') }}"></script>
  <script src="{{ url_for('static', filename='js/setup/new_prompt_modal.js') }}"></script>
  <script src="{{ url_for('static', filename='js/components/popup_menu.js') }}"></script>
  <script src="{{ url_for('static', filename='js/components/chat/popup_menu.js') }}"></script>
  <script src="{{ url_for('static', filename='js/components/user_icon.js') }}"></script>

</body>

</html>